{% extends "base.html" %}

{% block content %}
<div class="page-container predictor-page section-padding">
    <div class="container">
        <div class="predictor-header text-center">
            <h1 class="section-title dynamic-heading">Ghat Road Safety <span class="highlight">Predictor</span></h1>
            <p class="section-intro">Input current conditions to forecast potential accident severity. Use <i class="fas fa-microphone-alt"></i> for voice input.</p>
        </div>

        <!-- Prediction Result Modal -->
        <div id="predictionModal" class="modal">
            <div class="modal-content flexible-card">
                <span class="close-modal-btn">&times;</span>
                <div class="modal-icon-container">
                    <i id="modalIcon" class="fas"></i> <!-- Icon will be set by JS -->
                </div>
                <h2 id="modalTitle" class="modal-title dynamic-heading"></h2>
                <p id="modalMessage" class="modal-text"></p>
                <button id="modalOkButton" class="btn btn-primary">Understood</button>
            </div>
        </div>


        <form id="predictorForm" action="{{ url_for('predictor') }}" method="POST" class="predictor-form">
            <div class="bento-grid">
                <div class="bento-box flexible-card">
                    <label for="time" class="form-label"><i class="fas fa-clock icon-prefix"></i>Time of Travel</label>
                    <input type="time" id="time" name="time" class="form-control" required value="{{ request.form.time if request.form else '' }}">
                    <small>Select the approximate time.</small>
                </div>

                <div class="bento-box flexible-card">
                    <label for="location" class="form-label"><i class="fas fa-map-marker-alt icon-prefix"></i>Location</label>
                    <div class="input-with-mic">
                        <select id="location" name="location" class="form-control" required>
                            <option value="" disabled {% if not request.form.location %}selected{% endif %}>Select Ghat Road Location</option>
                            {% for loc in locations %}
                            <option value="{{ loc }}" {% if request.form.location == loc %}selected{% endif %}>{{ loc }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="mic-btn" data-target-select="location" aria-label="Use voice input for location">
                            <i class="fas fa-microphone-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="bento-box flexible-card">
                    <label for="road_condition" class="form-label"><i class="fas fa-road icon-prefix"></i>Road Condition</label>
                     <div class="input-with-mic">
                        <select id="road_condition" name="road_condition" class="form-control" required>
                            <option value="" disabled {% if not request.form.road_condition %}selected{% endif %}>Select Road Condition</option>
                            {% for cond in road_conditions %}
                            <option value="{{ cond }}" {% if request.form.road_condition == cond %}selected{% endif %}>{{ cond }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="mic-btn" data-target-select="road_condition" aria-label="Use voice input for road condition">
                            <i class="fas fa-microphone-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="bento-box flexible-card">
                    <label for="weather_condition" class="form-label"><i class="fas fa-cloud-sun-rain icon-prefix"></i>Weather Condition</label>
                    <div class="input-with-mic">
                        <select id="weather_condition" name="weather_condition" class="form-control" required>
                            <option value="" disabled {% if not request.form.weather_condition %}selected{% endif %}>Select Weather Condition</option>
                            {% for weather in weather_conditions %}
                            <option value="{{ weather }}" {% if request.form.weather_condition == weather %}selected{% endif %}>{{ weather }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="mic-btn" data-target-select="weather_condition" aria-label="Use voice input for weather condition">
                            <i class="fas fa-microphone-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="bento-box flexible-card">
                    <label for="vehicles_involved" class="form-label"><i class="fas fa-car-side icon-prefix"></i>Vehicles Involved (Est.)</label>
                    <select id="vehicles_involved" name="vehicles_involved" class="form-control" required>
                        <option value="" disabled {% if not request.form.vehicles_involved %}selected{% endif %}>Select Number of Vehicles</option>
                         {% for v_opt in vehicles_options %}
                            <option value="{{ v_opt }}" {% if request.form.vehicles_involved == v_opt %}selected{% endif %}>{{ v_opt }}</option>
                        {% else %} {# Fallback if options not loaded #}
                            <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4+</option>
                        {% endfor %}
                    </select>
                    <small>Estimated number of vehicles.</small>
                </div>
            </div>

            <div class="text-center submit-container">
                <button type="submit" class="btn btn-primary btn-lg predict-btn">
                    <i class="fas fa-cogs"></i> Predict Severity
                </button>
            </div>
        </form>
        <p id="voiceStatus" class="voice-status-indicator" aria-live="polite"></p>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const predictorForm = document.getElementById('predictorForm');
    const modal = document.getElementById('predictionModal');
    const closeModalBtn = modal.querySelector('.close-modal-btn');
    const modalOkButton = document.getElementById('modalOkButton');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalIcon = document.getElementById('modalIcon');

    // Show modal if prediction_result is available (passed from Flask)
    const predictionResultJson = {{ prediction_result|tojson|safe }};
    if (predictionResultJson) {
        modalTitle.textContent = predictionResultJson.title || "Prediction Result";
        modalMessage.textContent = predictionResultJson.text;
        
        modalIcon.className = 'fas'; // Reset classes
        if (predictionResultJson.severity === 'high') {
            modalIcon.classList.add('fa-exclamation-triangle', 'icon-high-risk');
            modal.classList.add('high-risk');
        } else if (predictionResultJson.severity === 'medium') {
            modalIcon.classList.add('fa-exclamation-circle', 'icon-medium-risk');
            modal.classList.add('medium-risk');
        } else {
            modalIcon.classList.add('fa-check-circle', 'icon-low-risk');
            modal.classList.add('low-risk');
        }
        modal.style.display = 'flex';
    }

    closeModalBtn.onclick = function() {
        modal.style.display = 'none';
        modal.className = 'modal'; // Reset risk classes
    }
    modalOkButton.onclick = function() {
        modal.style.display = 'none';
        modal.className = 'modal'; // Reset risk classes
    }
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
            modal.className = 'modal'; // Reset risk classes
        }
    }

    // --- Web Speech API for Voice Input ---
    const micButtons = document.querySelectorAll('.mic-btn');
    const voiceStatus = document.getElementById('voiceStatus');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        micButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetSelectId = this.dataset.targetSelect;
                const targetSelect = document.getElementById(targetSelectId);
                if (!targetSelect) return;

                const recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                voiceStatus.textContent = `Listening for ${targetSelect.labels[0].textContent.replace(' (Est.)','')}...`;
                voiceStatus.classList.add('active');
                this.classList.add('listening');
                
                recognition.start();

                recognition.onresult = function(event) {
                    const speechResult = event.results[0][0].transcript.trim().toLowerCase();
                    voiceStatus.textContent = `Heard: "${speechResult}". Processing...`;
                    
                    let matched = false;
                    for (let option of targetSelect.options) {
                        if (option.value && speechResult.includes(option.value.toLowerCase())) {
                            targetSelect.value = option.value;
                            matched = true;
                            break;
                        }
                        // Try matching text content as well
                        if (option.text && speechResult.includes(option.text.toLowerCase())) {
                             targetSelect.value = option.value;
                             matched = true;
                             break;
                        }
                    }

                    if (matched) {
                        voiceStatus.textContent = `Set ${targetSelect.labels[0].textContent} to "${targetSelect.options[targetSelect.selectedIndex].text}".`;
                    } else {
                        voice_Status.textContent = `Could not match "${speechResult}" to an option for ${targetSelect.labels[0].textContent}. Please try again or select manually.`;
                    }
                };

                recognition.onspeechend = function() {
                    recognition.stop();
                    button.classList.remove('listening');
                    // Keep status message for a bit or clear it
                    setTimeout(() => { voiceStatus.classList.remove('active'); voiceStatus.textContent = ''; }, 3000);
                };

                recognition.onerror = function(event) {
                    voiceStatus.textContent = 'Error recognizing speech: ' + event.error + ". Please try again or select manually.";
                    console.error('Speech recognition error:', event.error);
                    button.classList.remove('listening');
                     setTimeout(() => { voiceStatus.classList.remove('active'); voiceStatus.textContent = ''; }, 5000);
                };
            });
        });
    } else {
        voiceStatus.textContent = 'Speech recognition not supported by your browser.';
        micButtons.forEach(button => button.style.display = 'none'); // Hide mic buttons
    }
});
</script>
{% endblock %}
