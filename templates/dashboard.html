{% extends "base.html" %}
{% block title %}Dashboard - Ascent Alert{% endblock %}
{% block content %}
    <div class="dashboard-container">
        <h1>Accident Analysis Dashboard</h1>
        <div class="chart">
            <h2>Severity Distribution</h2>
            <canvas id="severityChart"></canvas>
        </div>
        <div class="chart">
            <h2>Weather Conditions</h2>
            <canvas id="weatherChart"></canvas>
        </div>
        <div class="chart">
            <h2>Road Conditions</h2>
            <canvas id="roadChart"></canvas>
        </div>
        <div class="chart small-chart">
            <h2>Hourly Accident Trends</h2>
            <canvas id="hourlyChart"></canvas>
        </div>
        <div class="pdf-button-container">
            <button id="downloadPDF" class="btn btn-predict"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
        </div>
    </div>

    <script>
        window.onload = function() {
            // Chart.js setup
            const severityCtx = document.getElementById('severityChart').getContext('2d');
            const weatherCtx = document.getElementById('weatherChart').getContext('2d');
            const roadCtx = document.getElementById('roadChart').getContext('2d');
            const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');

            // Severity Distribution (Pie Chart)
            new Chart(severityCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys({{ severity_counts | tojson }}),
                    datasets: [{
                        data: Object.values({{ severity_counts | tojson }}),
                        backgroundColor: ['#E10600', '#C0C0C0', '#FFD700']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            // Weather Conditions (Bar Chart)
            new Chart(weatherCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys({{ weather_counts | tojson }}),
                    datasets: [{
                        label: 'Accidents by Weather',
                        data: Object.values({{ weather_counts | tojson }}),
                        backgroundColor: '#E10600'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Road Conditions (Bar Chart)
            new Chart(roadCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys({{ road_counts | tojson }}),
                    datasets: [{
                        label: 'Accidents by Road Condition',
                        data: Object.values({{ road_counts | tojson }}),
                        backgroundColor: '#E10600'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Hourly Accident Trends (Line Chart)
            const hourlyData = Array(24).fill(0); // Initialize array for 24 hours
            const hourlyCounts = {{ hourly_counts | tojson }};
            for (let hour in hourlyCounts) {
                hourlyData[parseInt(hour)] = hourlyCounts[hour];
            }

            new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i.toString()),
                    datasets: [{
                        label: 'Accidents per Hour',
                        data: hourlyData,
                        borderColor: '#E10600',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // PDF Download
            document.getElementById('downloadPDF').addEventListener('click', async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    let yOffset = 20;

                    doc.setFontSize(20);
                    doc.text('Ascent Alert Dashboard Report', 105, yOffset, { align: 'center' });
                    yOffset += 20;

                    const charts = ['severityChart', 'weatherChart', 'roadChart', 'hourlyChart'];
                    for (const chartId of charts) {
                        const canvas = document.getElementById(chartId);
                        if (!canvas) {
                            console.error(`Canvas with ID ${chartId} not found.`);
                            continue;
                        }
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = doc.getImageProperties(imgData);
                        const pdfWidth = 180;
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        doc.addImage(imgData, 'PNG', 15, yOffset, pdfWidth, pdfHeight);
                        yOffset += pdfHeight + 20;

                        if (yOffset > 260) {
                            doc.addPage();
                            yOffset = 20;
                        }
                    }

                    doc.save('Ascent_Alert_Dashboard.pdf');
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Failed to generate PDF. Please ensure charts are rendered and try again.');
                }
            });
        };
    </script>
{% endblock %}