{% extends "base.html" %}

{% block content %}
<div class="page-container ai-chat-page section-padding">
    <div class="container">
        <div class="ai-chat-header text-center">
            <h1 class="section-title dynamic-heading">Ascent<span class="highlight">Alert</span> AI Safety Chat</h1>
            <p class="section-intro">Ask me anything about ghat road safety, driving tips, or interpreting conditions. Use <i class="fas fa-microphone-alt"></i> for voice input.</p>
        </div>

        <div class="chat-window flexible-card">
            <div id="chatMessages" class="chat-messages-area">
                <!-- Chat messages will appear here -->
                <div class="message ai-message">
                    <i class="fas fa-robot message-icon"></i>
                    <p>Hello! I'm the AscentAlert AI. How can I help you stay safe on ghat roads today?</p>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="userInput" placeholder="Type your safety question here..." rows="2"></textarea>
                <button id="sendButton" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send</button>
                <button id="voiceInputButtonChat" class="btn btn-secondary mic-btn-chat" aria-label="Use voice input for chat">
                    <i class="fas fa-microphone-alt"></i>
                </button>
            </div>
            <p id="chatVoiceStatus" class="voice-status-indicator" aria-live="polite"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const voiceInputButtonChat = document.getElementById('voiceInputButtonChat');
    const chatVoiceStatus = document.getElementById('chatVoiceStatus');

    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
        
        const icon = document.createElement('i');
        icon.classList.add('fas', sender === 'user' ? 'fa-user-astronaut' : 'fa-robot', 'message-icon');
        messageDiv.appendChild(icon);

        const p = document.createElement('p');
        p.innerHTML = text; // Use innerHTML to render potential markdown from AI (though simple text is safer)
        messageDiv.appendChild(p);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
    }

    async function sendMessageToAI(promptText) {
        if (!promptText.trim()) return;

        addMessage(promptText, 'user');
        userInput.value = ''; // Clear input field
        userInput.disabled = true;
        sendButton.disabled = true;
        voiceInputButtonChat.disabled = true;
        addMessage("<i>Thinking...</i>", 'ai-thinking'); // Temporary thinking message

        try {
            const response = await fetch("{{ url_for('ask_gemini') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: promptText }),
            });

            // Remove thinking message
            const thinkingMessage = chatMessages.querySelector('.ai-thinking-message p');
            if (thinkingMessage) thinkingMessage.parentElement.remove();


            if (!response.ok) {
                const errorData = await response.json();
                addMessage(`Error: ${errorData.error || response.statusText}`, 'ai');
                return;
            }

            const data = await response.json();
            addMessage(data.response, 'ai');

        } catch (error) {
            console.error('Error sending message to AI:', error);
            const thinkingMessage = chatMessages.querySelector('.ai-thinking-message p'); // Also remove if error
            if (thinkingMessage) thinkingMessage.parentElement.remove();
            addMessage('Sorry, I encountered an error trying to connect. Please try again later.', 'ai');
        } finally {
            userInput.disabled = false;
            sendButton.disabled = false;
            voiceInputButtonChat.disabled = false;
            userInput.focus();
        }
    }

    sendButton.addEventListener('click', () => sendMessageToAI(userInput.value));
    userInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessageToAI(userInput.value);
        }
    });

    // Voice Input for Chat
    const SpeechRecognitionChat = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognitionChat && voiceInputButtonChat) {
        voiceInputButtonChat.addEventListener('click', function() {
            const recognition = new SpeechRecognitionChat();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            chatVoiceStatus.textContent = "Listening...";
            chatVoiceStatus.classList.add('active');
            this.classList.add('listening');
            userInput.disabled = true;
            sendButton.disabled = true;

            recognition.start();

            recognition.onresult = function(event) {
                const speechResult = event.results[0][0].transcript;
                userInput.value = speechResult; // Populate textarea
                sendMessageToAI(speechResult); // Send it immediately
            };

            recognition.onspeechend = function() {
                recognition.stop();
                voiceInputButtonChat.classList.remove('listening');
                chatVoiceStatus.classList.remove('active');
                chatVoiceStatus.textContent = '';
            };

            recognition.onerror = function(event) {
                chatVoiceStatus.textContent = 'Error recognizing speech: ' + event.error;
                console.error('Chat speech recognition error:', event.error);
                voiceInputButtonChat.classList.remove('listening');
                setTimeout(() => { chatVoiceStatus.classList.remove('active'); chatVoiceStatus.textContent = ''; }, 3000);
                userInput.disabled = false; // Re-enable if error
                sendButton.disabled = false;
            };
        });
    } else {
        if (voiceInputButtonChat) voiceInputButtonChat.style.display = 'none';
        chatVoiceStatus.textContent = 'Voice input not supported by your browser for chat.';
    }
});
</script>
{% endblock %}
