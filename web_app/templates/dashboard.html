{% extends "base.html" %}
{% block content %}
<div class="dashboard-container gradient-bg">
    <h2>Accident Analysis Dashboard</h2>
    <div class="chart">
        <h3>Accidents by Weather</h3>
        <canvas id="weatherChart" class="small-chart"></canvas>
    </div>
    <div class="chart">
        <h3>Accidents by Time of Day</h3>
        <canvas id="timeChart" class="small-chart"></canvas>
    </div>
    <div class="chart">
        <h3>Alcohol vs Accident vs Driver Age (Multiple Bar)</h3>
        <canvas id="alcoholAccidentAgeChart" class="small-chart"></canvas>
    </div>
    <div class="chart">
        <h3>Accidents by Vehicle Type vs Road Condition (Multiple Bar)</h3>
        <canvas id="vehicleRoadChart" class="small-chart"></canvas>
    </div>
    <div class="pdf-button-container">
        <button onclick="exportPDF()" class="button dark-red">Export to PDF</button>
    </div>
</div>
<script>
// Bar Graph: Accidents by Weather
const weatherCtx = document.getElementById('weatherChart').getContext('2d');
new Chart(weatherCtx, {
    type: 'bar',
    data: {
        labels: Object.keys({{ weather_accidents | tojson }}),
        datasets: [{
            label: 'Accidents',
            data: Object.values({{ weather_accidents | tojson }}),
            backgroundColor: ['#4CAF50', '#F44336', '#2196F3', '#FFC107', '#9C27B0']
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Pie Chart: Accidents by Time of Day
const timeCtx = document.getElementById('timeChart').getContext('2d');
new Chart(timeCtx, {
    type: 'pie',
    data: {
        labels: Object.keys({{ time_accidents | tojson }}),
        datasets: [{
            data: Object.values({{ time_accidents | tojson }}),
            backgroundColor: ['#4CAF50', '#F44336', '#2196F3', '#FFC107']
        }]
    }
});

// Multiple Bar Graph: Alcohol vs Accident vs Driver Age
const alcoholAccidentAgeCtx = document.getElementById('alcoholAccidentAgeChart').getContext('2d');
const alcoholAccidentAgeData = {{ alcohol_accident_age | tojson }};
const ageGroups = [...new Set(alcoholAccidentAgeData.map(item => Math.floor(item.Driver_Age_mean / 10) * 10))].sort((a, b) => a - b);
const datasetsAlcohol = [
    {
        label: 'No Alcohol, No Accident',
        data: ageGroups.map(age => {
            const entry = alcoholAccidentAgeData.find(item => item.Driver_Alcohol === 0 && item.Accident === 0 && Math.floor(item.Driver_Age_mean / 10) * 10 === age);
            return entry ? entry.Driver_Age_count : 0;
        }),
        backgroundColor: '#4CAF50'
    },
    {
        label: 'No Alcohol, Accident',
        data: ageGroups.map(age => {
            const entry = alcoholAccidentAgeData.find(item => item.Driver_Alcohol === 0 && item.Accident === 1 && Math.floor(item.Driver_Age_mean / 10) * 10 === age);
            return entry ? entry.Driver_Age_count : 0;
        }),
        backgroundColor: '#F44336'
    },
    {
        label: 'Alcohol, No Accident',
        data: ageGroups.map(age => {
            const entry = alcoholAccidentAgeData.find(item => item.Driver_Alcohol === 1 && item.Accident === 0 && Math.floor(item.Driver_Age_mean / 10) * 10 === age);
            return entry ? entry.Driver_Age_count : 0;
        }),
        backgroundColor: '#2196F3'
    },
    {
        label: 'Alcohol, Accident',
        data: ageGroups.map(age => {
            const entry = alcoholAccidentAgeData.find(item => item.Driver_Alcohol === 1 && item.Accident === 1 && Math.floor(item.Driver_Age_mean / 10) * 10 === age);
            return entry ? entry.Driver_Age_count : 0;
        }),
        backgroundColor: '#FFC107'
    }
];
new Chart(alcoholAccidentAgeCtx, {
    type: 'bar',
    data: {
        labels: ageGroups.map(age => `${age}-${age + 9}`),
        datasets: datasetsAlcohol
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Number of Incidents'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Driver Age Group'
                }
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});

// Multiple Bar Chart: Accidents by Vehicle Type vs Road Condition
const vehicleRoadCtx = document.getElementById('vehicleRoadChart').getContext('2d');
const roadConditions = Object.keys({{ road_condition_accidents | tojson }});
const vehicleTypes = Object.keys({{ vehicle_accidents | tojson }});
const chartData = {{ data | tojson }};
const datasets = roadConditions.map(function(condition, index) {
    return {
        label: condition,
        data: vehicleTypes.map(function(vehicle) {
            const subset = chartData.filter(function(row) {
                return row.Vehicle_Type === vehicle && row.Road_Condition === condition;
            });
            return subset.reduce(function(sum, row) {
                return sum + (row.Accident || 0);
            }, 0);
        }),
        backgroundColor: ['#4CAF50', '#F44336', '#2196F3', '#FF9800'][index % 4]
    };
});
new Chart(vehicleRoadCtx, {
    type: 'bar',
    data: {
        labels: vehicleTypes,
        datasets: datasets
    },
    options: {
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});

// PDF Export with html2canvas (Improved Quality)
async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4',
        compress: true
    });
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(163, 0, 0);
    doc.text("Ascent Alert Dashboard", 10, 10);

    let yPos = 20;
    const charts = ['weatherChart', 'timeChart', 'alcoholAccidentAgeChart', 'vehicleRoadChart'];
    for (const chartId of charts) {
        const canvas = document.getElementById(chartId);
        const img = await html2canvas(canvas, { scale: 2 });
        const imgData = img.toDataURL('image/png', 1.0);
        doc.addImage(imgData, 'PNG', 10, yPos, 190, 70);
        yPos += 80;
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
    }

    doc.save('dashboard.pdf');
}
</script>
{% endblock %}