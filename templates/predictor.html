{% extends "base.html" %}
{% block title %}Ascent Alert{% endblock %}
{% block content %}
    <h1>Safety Predictor</h1>
    <p class="intro-text">Enter the details below to predict the accident severity on a ghat road. Use the microphone buttons to input values via voice for Location, Weather, and Road Condition.</p>
    
    <!-- Live Mode Toggle -->
    <div class="live-mode-toggle">
        <label for="liveMode">Live Weather Updates</label>
        <input type="checkbox" id="liveMode" name="liveMode">
        <label for="liveMode" class="toggle-switch"><i class="fas fa-bolt"></i></label>
        <p id="liveStatus">Live updates: OFF</p>
    </div>

    <div class="bento-grid">
        <div class="bento-box">
            <label for="time">Time</label>
            <input type="text" id="time" name="time" placeholder="H:MM:SS AM/PM" required>
        </div>
        <div class="bento-box">
            <label for="location">Location</label>
            <div class="input-with-mic">
                <select id="location" name="location" required onchange="updateLiveWeather()">
                    {% for loc in locations %}
                        <option value="{{ loc }}" {% if live_weather and loop.first %}selected{% endif %}>{{ locations_shortened[loc] }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="mic-btn" data-target="location"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="bento-box">
            <label for="weather">Weather</label>
            <div class="input-with-mic">
                <select id="weather" name="weather" required>
                    {% for weather in weather_conditions %}
                        <option value="{{ weather }}" {% if live_weather == weather %}selected{% endif %}>{{ weather }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="mic-btn" data-target="weather"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="bento-box">
            <label for="road">Road Condition</label>
            <div class="input-with-mic">
                <select id="road" name="road" required>
                    {% for road in road_conditions %}
                        <option value="{{ road }}" {% if live_road_condition == road %}selected{% endif %}>{{ road }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="mic-btn" data-target="road"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="bento-box">
            <label for="vehicles">Vehicles</label>
            <input type="number" id="vehicles" name="vehicles" min="1" max="5" required>
        </div>
        <div class="bento-box full-width">
            <button type="submit" class="btn btn-predict" form="predict-form"><i class="fas fa-calculator"></i> Predict Severity</button>
        </div>
    </div>
    <form id="predict-form" action="{{ url_for('predict') }}" method="POST" style="display: none;"></form>

    <!-- Display Weather Data -->
    <div class="weather-data-section">
        <h2>Current Weather Conditions</h2>
        <div id="weatherData" class="weather-card">
            {% if weather_data and 'error' not in weather_data %}
                <div class="weather-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <p><strong>Location:</strong> {{ weather_data.name }}, {{ weather_data.sys.country }}</p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-cloud"></i>
                    <p><strong>Weather:</strong> {{ weather_data.weather[0].description | capitalize }}</p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-thermometer-half"></i>
                    <p><strong>Temperature:</strong> {{ weather_data.main.temp }}°C (Feels like {{ weather_data.main.feels_like }}°C)</p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-tint"></i>
                    <p><strong>Humidity:</strong> {{ weather_data.main.humidity }}%</p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-wind"></i>
                    <p><strong>Wind Speed:</strong> {{ weather_data.wind.speed }} m/s, Direction: {{ weather_data.wind.deg }}°</p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-eye"></i>
                    <p><strong>Visibility:</strong> {{ weather_data.visibility / 1000 }} km</p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-cloud-sun"></i>
                    <p><strong>Cloud Cover:</strong> {{ weather_data.clouds.all }}%</p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-sun"></i>
                    <p><strong>Sunrise:</strong> <span id="sunrise">{{ weather_data.sys.sunrise }}</span></p>
                </div>
                <div class="weather-item">
                    <i class="fas fa-moon"></i>
                    <p><strong>Sunset:</strong> <span id="sunset">{{ weather_data.sys.sunset }}</span></p>
                </div>
                <script>
                    // Convert sunrise and sunset on page load
                    const sunrise = new Date(({{ weather_data.sys.sunrise }} + 19800) * 1000).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
                    const sunset = new Date(({{ weather_data.sys.sunset }} + 19800) * 1000).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
                    document.getElementById('sunrise').textContent = sunrise;
                    document.getElementById('sunset').textContent = sunset;
                </script>
            {% else %}
                <p>No weather data available. Please enable Live Weather Updates or check your API configuration.</p>
            {% endif %}
        </div>
    </div>

    <!-- Incident Reporting and Map -->
    <div class="incident-section">
        <h2>Incident Reports</h2>
        <div id="incidentMap" style="height: 400px; margin-bottom: 20px;"></div>
        
        <button id="reportIncidentBtn" class="btn btn-secondary"><i class="fas fa-exclamation-triangle"></i> Report Incident</button>
        <button id="viewIncidentsBtn" class="btn btn-secondary"><i class="fas fa-list"></i> View Incidents</button>
        <div id="incidentForm" style="display: none;">
            <h3>Report an Incident</h3>
            <form id="incidentSubmitForm" class="incident-form-grid">
                <div class="bento-box">
                    <label for="incidentLocation"><i class="fas fa-map-marker-alt"></i> Location:</label>
                    <select id="incidentLocation" name="location">
                        {% for loc in locations %}
                        <option value="{{ loc }}">{{ locations_shortened[loc] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="bento-box">
                    <label for="incidentType"><i class="fas fa-exclamation-circle"></i> Type:</label>
                    <select id="incidentType" name="type">
                        <option value="Accident">Accident</option>
                        <option value="Roadblock">Roadblock</option>
                        <option value="Weather Hazard">Weather Hazard</option>
                    </select>
                </div>
                <div class="bento-box">
                    <label for="incidentSeverity"><i class="fas fa-exclamation"></i> Severity:</label>
                    <select id="incidentSeverity" name="severity">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="bento-box">
                    <label for="incidentDescription"><i class="fas fa-comment"></i> Description:</label>
                    <textarea id="incidentDescription" name="description"></textarea>
                </div>
                <div class="bento-box full-width">
                    <button type="submit" class="btn btn-predict"><i class="fas fa-paper-plane"></i> Submit Report</button>
                </div>
            </form>
        </div>
        <div id="viewIncidents" style="display: none;">
            <h3>Reported Incidents</h3>
            <div id="incidentsList"></div>
        </div>
        <div id="alertsContainer"></div>
    </div>

    <div class="map-container">
        <h2>Ghat Roads Map</h2>
        <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1AjHYWHGxTpZTYWYi3YxUnWlayupuObo&ehbc=2E312F" width="100%" height="480"></iframe>
        <h2>View in 3D</h2>
        <p>Download the KML file below and open it in Google Earth to view the ghat road locations in 3D. Google Earth is free and available on desktop, mobile, or web browsers at <a href="https://earth.google.com">earth.google.com</a>.</p>
        <a href="{{ url_for('static', filename='ghat_roads.kml') }}" download class="btn btn-predict"><i class="fas fa-download"></i> Download Ghat Roads KML</a>
    </div>
    <div class="chat-container">
        <h2>Ask a Question</h2>
        <p>Use the chat below to ask questions about ghat roads, safety, or the predictor tool. You can also use the voice button to speak your question.</p>
        <div class="chat-input">
            <div class="input-with-mic">
                <input type="text" id="chat-input" placeholder="Type or speak your question (e.g., 'What is Khardung La?')" required>
                <button type="button" class="mic-btn" data-target="chat-input"><i class="fas fa-microphone"></i></button>
            </div>
            <button type="button" id="chat-send" class="btn btn-predict"><i class="fas fa-paper-plane"></i> Send</button>
        </div>
        <div class="chat-response">
            <h3>Answer:</h3>
            <div id="chat-output" class="chat-output-box">Your answer will appear here.</div>
        </div>
    </div>

    <!-- Include Leaflet.js for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Include Socket.IO for real-time alerts -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>

    <style>
        .input-with-mic {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mic-btn {
            background: var(--ferrari-red);
            color: var(--ferrari-white);
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .mic-btn.listening {
            background: var(--ferrari-gold);
        }
        .mic-btn:hover {
            background: var(--ferrari-gold);
        }
        .mic-btn:disabled {
            background: var(--ferrari-silver);
            cursor: not-allowed;
        }
        .alert {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .chat-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--ferrari-silver);
            border-radius: 5px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--ferrari-white);
        }
        #chat-send {
            padding: 10px 20px;
        }
        .chat-response {
            margin-top: 20px;
        }
        .chat-output-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--ferrari-silver);
            min-height: 100px;
            font-size: 16px;
        }
    </style>

    <script>
        // Live Weather Updates
        const liveModeToggle = document.getElementById('liveMode');
        const liveStatus = document.getElementById('liveStatus');
        let liveUpdateInterval = null;

        liveModeToggle.addEventListener('change', function() {
            if (this.checked) {
                liveStatus.textContent = 'Live updates: ON';
                updateLiveWeather();
                liveUpdateInterval = setInterval(updateLiveWeather, 300000); // Update every 5 minutes
            } else {
                liveStatus.textContent = 'Live updates: OFF';
                clearInterval(liveUpdateInterval);
            }
        });

        async function updateLiveWeather() {
            const location = document.getElementById('location').value;
            try {
                const response = await fetch(`/fetch_live_weather?location=${encodeURIComponent(location)}`);
                const data = await response.json();
                if (data.success) {
                    if (liveModeToggle.checked) {
                        document.getElementById('weather').value = data.weather || 'Clear';
                        document.getElementById('road').value = data.road_condition || 'Dry';
                        
                        // Update weather data display
                        const weatherDataDiv = document.getElementById('weatherData');
                        if (data.weather_data && !data.weather_data.error) {
                            const sunrise = new Date((data.weather_data.sys.sunrise + 19800) * 1000).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
                            const sunset = new Date((data.weather_data.sys.sunset + 19800) * 1000).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
                            weatherDataDiv.innerHTML = `
                                <div class="weather-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <p><strong>Location:</strong> ${data.weather_data.name}, ${data.weather_data.sys.country}</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-cloud"></i>
                                    <p><strong>Weather:</strong> ${data.weather_data.weather[0].description}</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-thermometer-half"></i>
                                    <p><strong>Temperature:</strong> ${data.weather_data.main.temp}°C (Feels like ${data.weather_data.main.feels_like}°C)</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-tint"></i>
                                    <p><strong>Humidity:</strong> ${data.weather_data.main.humidity}%</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-wind"></i>
                                    <p><strong>Wind Speed:</strong> ${data.weather_data.wind.speed} m/s, Direction: ${data.weather_data.wind.deg}°</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-eye"></i>
                                    <p><strong>Visibility:</strong> ${data.weather_data.visibility / 1000} km</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-cloud-sun"></i>
                                    <p><strong>Cloud Cover:</strong> ${data.weather_data.clouds.all}%</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-sun"></i>
                                    <p><strong>Sunrise:</strong> ${sunrise}</p>
                                </div>
                                <div class="weather-item">
                                    <i class="fas fa-moon"></i>
                                    <p><strong>Sunset:</strong> ${sunset}</p>
                                </div>
                            `;
                        } else {
                            weatherDataDiv.innerHTML = '<p>No weather data available. Please check your API configuration.</p>';
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching live weather:', error);
            }
        }

        // Initialize the map
        const map = L.map('incidentMap').setView([20.5937, 78.9629], 5); // Center on India
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Fetch and display recent incidents
        async function loadIncidents() {
            try {
                const response = await fetch('/get_incidents');
                const incidents = await response.json();
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                incidents.forEach(incident => {
                    const marker = L.marker([incident.latitude, incident.longitude]).addTo(map);
                    marker.bindPopup(`
                        <b>${incident.type}</b><br>
                        Location: ${incident.location}<br>
                        Severity: ${incident.severity}<br>
                        Description: ${incident.description || 'N/A'}<br>
                        Reported by: ${incident.username}<br>
                        Time: ${new Date(incident.timestamp).toLocaleString()}
                    `);
                });
            } catch (error) {
                console.error('Error loading incidents:', error);
            }
        }
        loadIncidents();

        // Toggle incident form visibility
        document.getElementById('reportIncidentBtn').addEventListener('click', () => {
            const form = document.getElementById('incidentForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            document.getElementById('viewIncidents').style.display = 'none'; // Hide view section
        });

        // Toggle view incidents visibility and add delete functionality
        document.getElementById('viewIncidentsBtn').addEventListener('click', async () => {
            const viewSection = document.getElementById('viewIncidents');
            viewSection.style.display = viewSection.style.display === 'none' ? 'block' : 'none';
            document.getElementById('incidentForm').style.display = 'none'; // Hide form section

            if (viewSection.style.display === 'block') {
                const selectedLocation = document.getElementById('location').value;
                try {
                    const response = await fetch('/get_incidents');
                    const incidents = await response.json();
                    const filteredIncidents = incidents.filter(incident => incident.location === selectedLocation);
                    const incidentsList = document.getElementById('incidentsList');
                    if (filteredIncidents.length > 0) {
                        incidentsList.innerHTML = filteredIncidents.map((incident, index) => `
                            <div class="incident" data-incident-id="${index}">
                                <p><strong>Reported by:</strong> ${incident.username}</p>
                                <p><strong>Type:</strong> ${incident.type}</p>
                                <p><strong>Severity:</strong> ${incident.severity}</p>
                                <p><strong>Description:</strong> ${incident.description || 'N/A'}</p>
                                <p><strong>Time:</strong> ${new Date(incident.timestamp).toLocaleString()}</p>
                                <button class="delete-btn" onclick="deleteIncident(${index}, '${incident.username}')"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        `).join('');
                    } else {
                        incidentsList.innerHTML = '<p>No incidents reported for this location.</p>';
                    }
                } catch (error) {
                    console.error('Error loading incidents:', error);
                    incidentsList.innerHTML = '<p>Error loading incidents.</p>';
                }
            }
        });

        // Delete incident function
        async function deleteIncident(incidentId, username) {
            if (!confirm('Are you sure you want to delete this incident?')) return;
            try {
                const currentUser = "{{ session['username'] }}";
                if (currentUser !== username && currentUser !== 'admin') {
                    alert('You can only delete incidents you reported.');
                    return;
                }
                const response = await fetch(`/delete_incident/${incidentId}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    alert('Incident deleted successfully!');
                    document.querySelector(`.incident[data-incident-id="${incidentId}"]`).remove();
                    loadIncidents(); // Refresh map
                } else {
                    alert('Error deleting incident: ' + result.error);
                }
            } catch (error) {
                alert('Error deleting incident: ' + error.message);
            }
        }

        // Handle incident form submission
        document.getElementById('incidentSubmitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const location = document.getElementById('incidentLocation').value;
            const type = document.getElementById('incidentType').value;
            const severity = document.getElementById('incidentSeverity').value;
            const description = document.getElementById('incidentDescription').value;
            
            try {
                const response = await fetch('/report_incident', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location, type, severity, description })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Incident reported successfully!');
                    document.getElementById('incidentForm').style.display = 'none';
                    loadIncidents(); // Refresh map
                } else {
                    alert('Error reporting incident: ' + result.error);
                }
            } catch (error) {
                alert('Error reporting incident: ' + error.message);
            }
        });

        // Connect to WebSocket for real-time alerts
        const socket = io('/alerts');
        let currentLocation = document.getElementById('location').value;
        socket.emit('join', currentLocation);

        socket.on('connect', () => {
            console.log('Connected to WebSocket server');
        });

        socket.on('new_incident', (incident) => {
            if (incident.location === currentLocation) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert';
                alertDiv.innerHTML = `
                    <strong>Alert!</strong> New ${incident.type} reported at ${incident.location} (Severity: ${incident.severity})<br>
                    ${incident.description || ''}<br>
                    Time: ${new Date(incident.timestamp).toLocaleString()}
                `;
                document.getElementById('alertsContainer').prepend(alertDiv);
                
                // Add marker to map
                const marker = L.marker([incident.latitude, incident.longitude]).addTo(map);
                marker.bindPopup(`
                    <b>${incident.type}</b><br>
                    Location: ${incident.location}<br>
                    Severity: ${incident.severity}<br>
                    Description: ${incident.description || 'N/A'}<br>
                    Time: ${new Date(incident.timestamp).toLocaleString()}
                `);
            }
        });

        socket.on('incident_deleted', (data) => {
            if (data.location === currentLocation) {
                const incidentElement = document.querySelector(`.incident[data-incident-id="${data.incident_id}"]`);
                if (incidentElement) {
                    incidentElement.remove();
                }
                loadIncidents(); // Refresh map
            }
        });

        // Update room when location changes
        document.getElementById('location').addEventListener('change', () => {
            socket.emit('leave', currentLocation);
            currentLocation = document.getElementById('location').value;
            socket.emit('join', currentLocation);
            document.getElementById('alertsContainer').innerHTML = ''; // Clear alerts
        });

        // Existing speech recognition and chat functionality
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Sorry, your browser does not support the Web Speech API. Please use a supported browser like Chrome or Edge.");
            document.querySelectorAll('.mic-btn').forEach(btn => btn.disabled = true);
        } else {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            const qaDatabase = {
                "what is khardung la": "Khardung La Pass, located in Ladakh, India, is one of the highest motorable passes in the world at an elevation of 5,359 meters (17,582 feet). It’s a popular route for travelers heading to Nubra Valley.",
                "what are ghat roads": "Ghat roads are mountain passes or roads in India, often found in the Western Ghats or Himalayan regions. They are known for their steep inclines, sharp bends, and scenic views, but can be dangerous due to weather and road conditions.",
                "how to drive safely on ghat roads": "To drive safely on ghat roads, maintain a low speed, use low gears on steep slopes, honk at blind curves, avoid overtaking on sharp bends, and ensure your vehicle is in good condition (brakes, tires, etc.).",
                "what affects accident severity": "Accident severity on ghat roads is affected by factors like time of day, weather conditions (e.g., rain, fog), road conditions (e.g., wet, damaged), the number of vehicles involved, and driver behavior.",
                "how does the predictor work": "The Safety Predictor uses a machine learning model trained on historical accident data. It takes inputs like Time, Location, Weather Condition, Road Condition, and Vehicles Involved to predict the accident severity (Low, Medium, High).",
                "what is the best time to travel on ghat roads": "The best time to travel on ghat roads is during daylight hours, preferably in the morning, when visibility is high and traffic is lower. Avoid traveling at night or during heavy rain or fog."
            };

            document.querySelectorAll('.mic-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);

                    if (button.classList.contains('listening')) {
                        recognition.stop();
                        return;
                    }

                    button.classList.add('listening');
                    recognition.start();

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.trim().toLowerCase();
                        console.log(`Recognized: ${transcript}`);

                        if (targetId === 'chat-input') {
                            targetInput.value = transcript;
                        } else {
                            const options = Array.from(targetInput.options).map(opt => ({
                                text: opt.text.toLowerCase(),
                                value: opt.value
                            }));

                            let bestMatch = null;
                            let highestScore = 0;
                            options.forEach(option => {
                                const score = similarity(transcript, option.text);
                                if (score > highestScore) {
                                    highestScore = score;
                                    bestMatch = option;
                                }
                            });

                            if (bestMatch && highestScore > 0.5) {
                                targetInput.value = bestMatch.value;
                            } else {
                                alert(`Could not match "${transcript}" to any option in ${targetId}. Please try again.`);
                            }
                        }
                    };

                    recognition.onend = () => {
                        button.classList.remove('listening');
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        button.classList.remove('listening');
                        if (event.error === 'no-speech') {
                            alert('No speech detected. Please try again.');
                        } else if (event.error === 'not-allowed') {
                            alert('Microphone access denied. Please allow microphone permissions.');
                        } else {
                            alert('An error occurred during speech recognition: ' + event.error);
                        }
                    };
                });
            });

            document.getElementById('chat-send').addEventListener('click', () => {
                const questionInput = document.getElementById('chat-input');
                const question = questionInput.value.trim().toLowerCase();
                const chatOutput = document.getElementById('chat-output');

                if (!question) {
                    alert('Please enter a question.');
                    return;
                }

                let bestMatch = null;
                let highestScore = 0;
                Object.keys(qaDatabase).forEach(q => {
                    const score = similarity(question, q);
                    if (score > highestScore) {
                        highestScore = score;
                        bestMatch = q;
                    }
                });

                if (bestMatch && highestScore > 0.5) {
                    chatOutput.textContent = qaDatabase[bestMatch];
                } else {
                    chatOutput.textContent = "Sorry, I couldn’t find an answer to your question. Try asking about ghat roads, safety, or the predictor tool (e.g., 'What is Khardung La?' or 'How does the predictor work?').";
                }

                questionInput.value = '';
            });

            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('chat-send').click();
                }
            });

            function similarity(s1, s2) {
                s1 = s1.toLowerCase();
                s2 = s2.toLowerCase();
                if (s1 === s2) return 1.0;
                if (s1.length < s2.length) [s1, s2] = [s2, s1];
                if (s2.length === 0) return 0.0;

                const previousRow = Array(s2.length + 1).fill(0).map((_, i) => i);
                for (let i = 0; i < s1.length; i++) {
                    const currentRow = [i + 1];
                    for (let j = 0; j < s2.length; j++) {
                        const insertions = previousRow[j + 1] + 1;
                        const deletions = currentRow[j] + 1;
                        const substitutions = previousRow[j] + (s1[i] !== s2[j] ? 1 : 0);
                        currentRow.push(Math.min(insertions, deletions, substitutions));
                    }
                    previousRow.splice(0, previousRow.length, ...currentRow);
                }
                const distance = previousRow[s2.length];
                return 1.0 - distance / Math.max(s1.length, s2.length);
            }
        }
    </script>
{% endblock %}