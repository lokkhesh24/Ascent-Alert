{% extends "base.html" %}
{% block title %}Ascent Alert{% endblock %}
{% block content %}
    <h1>Safety Predictor</h1>
    <p class="intro-text">Enter the details below to predict the accident severity on a ghat road. Use the microphone buttons to input values via voice for Location, Weather, and Road Condition.</p>
    <div class="bento-grid">
        <div class="bento-box">
            <label for="time">Time</label>
            <input type="text" id="time" name="time" placeholder="H:MM:SS AM/PM" required>
        </div>
        <div class="bento-box">
            <label for="location">Location</label>
            <div class="input-with-mic">
                <select id="location" name="location" required>
                    {% for loc in locations %}
                        <option value="{{ loc }}">{{ locations_shortened[loc] }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="mic-btn" data-target="location"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="bento-box">
            <label for="weather">Weather</label>
            <div class="input-with-mic">
                <select id="weather" name="weather" required>
                    {% for weather in weather_conditions %}
                        <option value="{{ weather }}">{{ weather }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="mic-btn" data-target="weather"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="bento-box">
            <label for="road">Road Condition</label>
            <div class="input-with-mic">
                <select id="road" name="road" required>
                    {% for road in road_conditions %}
                        <option value="{{ road }}">{{ road }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="mic-btn" data-target="road"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="bento-box">
            <label for="vehicles">Vehicles</label>
            <input type="number" id="vehicles" name="vehicles" min="1" max="5" required>
        </div>
        <div class="bento-box full-width">
            <button type="submit" class="btn btn-predict" form="predict-form">Predict Severity</button>
        </div>
    </div>
    <form id="predict-form" action="{{ url_for('predict') }}" method="POST" style="display: none;"></form>
    <div class="map-container">
        <h2>Ghat Roads Map</h2>
        <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1AjHYWHGxTpZTYWYi3YxUnWlayupuObo&ehbc=2E312F" width="100%" height="480"></iframe>
        <h2>View in 3D</h2>
        <p>Download the KML file below and open it in Google Earth to view the ghat road locations in 3D. Google Earth is free and available on desktop, mobile, or web browsers at <a href="https://earth.google.com">earth.google.com</a>.</p>
        <a href="{{ url_for('static', filename='ghat_roads.kml') }}" download class="btn btn-predict">Download Ghat Roads KML</a>
    </div>
    <div class="chat-container">
        <h2>Ask a Question</h2>
        <p>Use the chat below to ask questions about ghat roads, safety, or the predictor tool. You can also use the voice button to speak your question.</p>
        <div class="chat-input">
            <div class="input-with-mic">
                <input type="text" id="chat-input" placeholder="Type or speak your question (e.g., 'What is Khardung La?')" required>
                <button type="button" class="mic-btn" data-target="chat-input"><i class="fas fa-microphone"></i></button>
            </div>
            <button type="button" id="chat-send" class="btn btn-predict">Send</button>
        </div>
        <div class="chat-response">
            <h3>Answer:</h3>
            <div id="chat-output" class="chat-output-box">Your answer will appear here.</div>
        </div>
    </div>

    <!-- Include Font Awesome for microphone icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .input-with-mic {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mic-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .mic-btn.listening {
            background: #ff4444;
        }
        .mic-btn:hover {
            background: #45a049;
        }
        .mic-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .map-container iframe {
            max-width: 100%;
            border: none;
            margin-bottom: 20px;
        }
        .chat-container {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 10px;
        }
        .chat-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        #chat-send {
            padding: 10px 20px;
        }
        .chat-response {
            margin-top: 20px;
        }
        .chat-output-box {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            min-height: 100px;
            font-size: 16px;
        }
    </style>
    <script>
        // Check for SpeechRecognition API support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Sorry, your browser does not support the Web Speech API. Please use a supported browser like Chrome or Edge.");
            document.querySelectorAll('.mic-btn').forEach(btn => btn.disabled = true);
        } else {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            // Predefined questions and answers for AI simulation
            const qaDatabase = {
                "what is khardung la": "Khardung La Pass, located in Ladakh, India, is one of the highest motorable passes in the world at an elevation of 5,359 meters (17,582 feet). Itâ€™s a popular route for travelers heading to Nubra Valley.",
                "what are ghat roads": "Ghat roads are mountain passes or roads in India, often found in the Western Ghats or Himalayan regions. They are known for their steep inclines, sharp bends, and scenic views, but can be dangerous due to weather and road conditions.",
                "how to drive safely on ghat roads": "To drive safely on ghat roads, maintain a low speed, use low gears on steep slopes, honk at blind curves, avoid overtaking on sharp bends, and ensure your vehicle is in good condition (brakes, tires, etc.).",
                "what affects accident severity": "Accident severity on ghat roads is affected by factors like time of day, weather conditions (e.g., rain, fog), road conditions (e.g., wet, damaged), the number of vehicles involved, and driver behavior.",
                "how does the predictor work": "The Safety Predictor uses a machine learning model trained on historical accident data. It takes inputs like Time, Location, Weather Condition, Road Condition, and Vehicles Involved to predict the accident severity (Low, Medium, High).",
                "what is the best time to travel on ghat roads": "The best time to travel on ghat roads is during daylight hours, preferably in the morning, when visibility is high and traffic is lower. Avoid traveling at night or during heavy rain or fog."
            };

            // Handle all microphone buttons (for dropdowns and chat input)
            document.querySelectorAll('.mic-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);

                    // Toggle listening state
                    if (button.classList.contains('listening')) {
                        recognition.stop();
                        return;
                    }

                    button.classList.add('listening');
                    recognition.start();

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.trim().toLowerCase();
                        console.log(`Recognized: ${transcript}`);

                        if (targetId === 'chat-input') {
                            targetInput.value = transcript;
                        } else {
                            // Handle dropdowns (location, weather, road)
                            const options = Array.from(targetInput.options).map(opt => ({
                                text: opt.text.toLowerCase(),
                                value: opt.value
                            }));

                            // Find the closest matching option
                            let bestMatch = null;
                            let highestScore = 0;
                            options.forEach(option => {
                                const score = similarity(transcript, option.text);
                                if (score > highestScore) {
                                    highestScore = score;
                                    bestMatch = option;
                                }
                            });

                            if (bestMatch && highestScore > 0.5) {
                                targetInput.value = bestMatch.value;
                            } else {
                                alert(`Could not match "${transcript}" to any option in ${targetId}. Please try again.`);
                            }
                        }
                    };

                    recognition.onend = () => {
                        button.classList.remove('listening');
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        button.classList.remove('listening');
                        if (event.error === 'no-speech') {
                            alert('No speech detected. Please try again.');
                        } else if (event.error === 'not-allowed') {
                            alert('Microphone access denied. Please allow microphone permissions.');
                        } else {
                            alert('An error occurred during speech recognition: ' + event.error);
                        }
                    };
                });
            });

            // Handle chat submission
            document.getElementById('chat-send').addEventListener('click', () => {
                const questionInput = document.getElementById('chat-input');
                const question = questionInput.value.trim().toLowerCase();
                const chatOutput = document.getElementById('chat-output');

                if (!question) {
                    alert('Please enter a question.');
                    return;
                }

                // Find the closest matching question in the QA database
                let bestMatch = null;
                let highestScore = 0;
                Object.keys(qaDatabase).forEach(q => {
                    const score = similarity(question, q);
                    if (score > highestScore) {
                        highestScore = score;
                        bestMatch = q;
                    }
                });

                if (bestMatch && highestScore > 0.5) {
                    chatOutput.textContent = qaDatabase[bestMatch];
                } else {
                    chatOutput.textContent = "Sorry, I couldnâ€™t find an answer to your question. Try asking about ghat roads, safety, or the predictor tool (e.g., 'What is Khardung La?' or 'How does the predictor work?').";
                }

                // Clear the input field
                questionInput.value = '';
            });

            // Allow pressing Enter to send the chat message
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('chat-send').click();
                }
            });

            // Simple string similarity function (Levenshtein distance approximation)
            function similarity(s1, s2) {
                s1 = s1.toLowerCase();
                s2 = s2.toLowerCase();
                if (s1 === s2) return 1.0;
                if (s1.length < s2.length) [s1, s2] = [s2, s1];
                if (s2.length === 0) return 0.0;

                const previousRow = Array(s2.length + 1).fill(0).map((_, i) => i);
                for (let i = 0; i < s1.length; i++) {
                    const currentRow = [i + 1];
                    for (let j = 0; j < s2.length; j++) {
                        const insertions = previousRow[j + 1] + 1;
                        const deletions = currentRow[j] + 1;
                        const substitutions = previousRow[j] + (s1[i] !== s2[j] ? 1 : 0);
                        currentRow.push(Math.min(insertions, deletions, substitutions));
                    }
                    previousRow.splice(0, previousRow.length, ...currentRow);
                }
                const distance = previousRow[s2.length];
                return 1.0 - distance / Math.max(s1.length, s2.length);
            }
        }
    </script>
{% endblock %}